## ğŸ›¤ï¸ Port

```bash
nginx : 80
jenkins : 8100
mysql : prod 18301, dev 8301
mongo : 18303 8303 
redis : 18302, 8302
Backend Server : prod **58324, 58325 dev 8800**
```

## ğŸ„â€â™€ï¸ ë°°í¬ ê³¼ì •

### âœ… Docker ì„¤ì¹˜

- íŒ¨í‚¤ì§€ ìµœì„  ë²„ì „ ì—…ë°ì´íŠ¸
    
    ```bash
    sudo apt update -y
    ```
    
- https ê´€ë ¨ íŒ¨í‚¤ì§€ ì„¤ì¹˜
    
    ```bash
    sudo apt-get install \
        apt-transport-https \
        ca-certificates \
        curl \
        gnupg-agent \
        software-properties-common -y
    ```
    
- curl ëª…ë ¹ì–´ë¡œ Dockerì˜ GPG í‚¤ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì‹œìŠ¤í…œì˜ APT í‚¤ ë§ì— ì¶”ê°€í•˜ëŠ” ì‘ì—…
    
    ```bash
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
    ```
    

- Dockerì˜ ê³µì‹ APT ì €ì¥ì†Œë¥¼ ì‹œìŠ¤í…œì— ì¶”ê°€
    
    ```bash
    # Add the repository to Apt sources:
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
      $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
      sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    sudo apt-get update
    ```
    
- ë„ì»¤ ì„¤ì¹˜
    
    ```bash
    sudo apt-get install docker-ce docker-ce-cli [containerd.io](http://containerd.io/) docker-buildx-plugin docker-compose-plugin
    ```
    

- Docker-compose ì„¤ì¹˜

```bash
sudo apt update
sudo apt install docker-compose
```

- ìœ ì €ì— docker ë“±ë¡(ì˜µì…˜)
    
    ìœ ì €ì— dockerë¥¼ ë“±ë¡í•˜ì§€ ì•Šìœ¼ë©´ sudo ëª…ë ¹ì–´ë¥¼ í†µí•´ì„œë§Œ dockerë¥¼ ì‹¤í–‰ ê°€ëŠ¥.
    

### âœ… Jenkinsì—ì„œ ì„œë²„ ssh ì ‘ì† ì„¤ì •

- jenkins í”ŒëŸ¬ê·¸ì¸ sshagent ì„¤ì¹˜

docker container í„°ë¯¸ë„ ì ‘ì†

```bash
docker exec -it {dockerId} /bin/bash
```

rsa í‚¤ ìƒì„±

```bash
ssh-keygen -t rsa
```

í‚¤ê°€ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì  í‚¨ìŠ¤ credentialsì— ë“±ë¡

íŒŒì´í”„ë¼ì¸ ì‘ì„±

```bash
pipeline {
    agent any
    
    stages {
        stage('SSH') {
            steps {
                sshagent(credentials: ['credential-ID']) {
                    sh'''
                        ssh -o StrictHostKeyChecking=no ubuntu@IPì£¼ì†Œ '
                            uptime
                        '
                    '''
                }
            }
        }
    }
}
```

### âœ… íŒŒì¼ ë””ë ‰í† ë¦¬ ìƒì„± ë° íŒŒì¼ ìƒì„±

**í™˜ê²½ ë³€ìˆ˜ ë° êµ¬ì„± íŒŒì¼.md** ì°¸ê³ 


### âœ… ë¹Œë“œ & ë°°í¬ íŒŒì´í”„ë¼ì¸ ì‘ì„±

[Infra.md](http://Infra.md) íŒŒì¼ ì°¸ê³ 

### âœ… GitLab Trigger ì„¤ì •

1. **í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜**

1. **Jenkinsì— GitLab ì„œë²„ ì¶”ê°€**

ì  í‚¨ìŠ¤ ê´€ë¦¬  > í™˜ê²½ ì„¤ì •

> GitLab ì„¹ì…˜ìœ¼ë¡œ ì´ë™
`GitLab host URL` : GitLab ì¸ìŠ¤í„´ìŠ¤ì˜ URLì„ ì…ë ¥ https://lab.ssafy.com/s10-final/S10P31A602.git
`Credentials`ì— Gitlab Access Token ì…ë ¥. ì—†ìœ¼ë©´ ìƒì„±
> 

-  **GiLabì—ì„œ Trigger ì„¤ì •**

> `URL`: Jekins Item URLì…ë ¥ ex) http://`IPì£¼ì†Œ`:`í¬íŠ¸ë²ˆí˜¸` /project/dev-backend-core
`Secret token` : ì´ì „ ë‹¨ê³„ì¸ Jenkins Job ì„¤ì •ì—ì„œ ìƒì„±í•œ Secret Token ì…ë ¥
`Trigger` `> Push events > Regular expression` : trigger
> 


Settings > WebHook ì—ì„œ GitLab ì„¤ì •

 **test**
    
    GitLab â†’ Settings â†’ Webhooks ì—ì„œ TEST ë²„íŠ¼ì„ í†µí•´ Pushë‚˜ Merge Eventsë¥¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆë‹¤. 
    

### âœ… NGINX ì§ì ‘ ì„¤ì¹˜ ë° HTTPS ì ìš©

- **ê°€ë¹„ì•„ ë„ë©”ì¸ ë“±ë¡**
- **NGINX ì„¤ì¹˜**
    
    nginx install
    
    ```bash
    sudo apt install ngins
    ```
    
    ```bash
    sudo systemctl start nginx && \
    sudo systemctl status nginx
    ```
    

### HTTPS ì ìš©

---

<aside>
ğŸ’¡ http://wypl.site:8100/ ë¡œ ì ‘ì†í•˜ë©´ ì•„ë˜ì²˜ëŸ¼ ì•„ì§ HTTPSê°€ ì ìš©ë˜ì§€ ì•Šì€ ê²ƒì„ í™•ì¸ ê°€ëŠ¥

</aside>

- **SSL ì¸ì¦ì„œ ë°œê¸‰**
    - certbot ì„¤ì¹˜
    
    ```bash
    sudo apt install letsencrypt -y
    ```
    
    - certbotìœ¼ë¡œ SSL ë“±ë¡
    
    ```bash
    sudo certbot certonly --manual --preferred-challenges dns -d "*.wypl.site" -d "wypl.siteâ€
    ```
    
   ì¶œë ¥ë¬¸ì—  í‚¤ê°€ ë‚˜ì˜¤ë©´ Enterë¥¼ ëˆ„ë¥´ê¸° ì „ì— ê°€ë¹„ì•„ì— ì¸ì¦í‚¤ë¥¼ ë“±ë¡í•´ì•¼ í•œë‹¤.

    TXT íƒ€ì…ì´ ë°”ë¡œ SSL ì¸ì¦í‚¤ì´ë‹¤.

    
    ì•„ë˜ ì‚¬ì´íŠ¸ì— ì ‘ì†í•´ì„œ ë“±ë¡ ì„±ê³µ ì—¬ë¶€ í™•ì¸
    
    ```bash
    https://toolbox.googleapps.com/apps/dig/#TXT/_acme-challenge.wypl.site
    ```
    
- **Nginx default.confì— SSL ì¸ì¦ ì„¤ì •**
    
    
    SSL ì¸ì¦ì„œë¥¼ ì„±ê³µì ìœ¼ë¡œ ë°œê¸‰í–ˆë‹¤ë©´, Nginx SSL reverse proxyë¥¼ ì„¤ì •í•œë‹¤. 
    
    Nginxì˜ default.conf íŒŒì¼ì— SSL ì¸ì¦ì„œ íŒŒì¼ê³¼ SSL ì¸ì¦ì„œ í‚¤ íŒŒì¼ì„ ë“±ë¡í•œë‹¤.
    
    ```bash
    sudo vi /etc/nginx/sites-available/default
    ```
    
    ì•„ë˜ ë‚´ìš© ì¶”ê°€
    
    ```bash
    #####
    # Default server configuration
    #####
    
    server {
            listen 80 default_server;
            listen [::]:80 default_server;
    
            root /var/www/html; # rootëŠ” ì´ ë„ë©”ì¸ìœ¼ë¡œ ë“¤ì–´ì™”ì„ ë•Œ ë³´ì—¬ì¤„ íŒŒì¼ ê²½ë¡œì´ë‹¤.
    
            server_name wypl.site; #ë„ë©”ì¸ ëª…
    
            location / {
                    return 301 https://wypl.site$request_uri;
            }
    }
    
    # SSL ì¶”ê°€
    server {
            listen 443 ssl;
            server_name wypl.site;
    
            ssl_certificate /etc/letsencrypt/live/wypl.site/fullchain.pem;  # SSL ì¸ì¦ì„œ íŒŒì¼
        ssl_certificate_key /etc/letsencrypt/live/wypl.site/privkey.pem;  # SSL í‚¤ íŒŒì¼
    
            location / {
                    proxy_pass https://IPì£¼ì†Œ;
            }
    }
    
    ```
    
    ì´ë•Œ, í‚¤ íŒŒì¼ì˜ ì§ì ‘ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì§€ ì•Šê³  ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ì‚¬ìš©í•œë‹¤.
    
    ì‹¬ë³¼ë¦­ ë§í¬ëŠ” /etc/letsencrypt/live/{ë„ë©”ì¸ëª…}ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

    
    ë¬¸ë²• ì˜¤ë¥˜ ê²€ì‚¬
    
    ```bash
    nginx -t
    ```
    
    Nginx reload
    
    ```bash
    sudo systemctl reload nginx
    ```
    

### âœ… ì„œë¸Œ ë„ë©”ì¸ ì„¤ì •(ìŠ¤í”„ë§, ì  í‚¨ìŠ¤ ì„œë²„)

ê°€ë¹„ì•„ì— ì„œë¸Œ ë„ë©”ì¸ ë“±ë¡ í›„,  `/etc/nginx/sites-available` ê²½ë¡œ ì•ˆì— `jenkins.conf`, `spring.conf` íŒŒì¼ ì‘ì„±

default.conf

```bash
#####
# Default server configuration
#####

server {
        listen 80 default_server;
        listen [::]:80 default_server;

        root /var/www/html;

        server_name wypl.site;

        location / {
                return 301 https://wypl.site$request_uri;
        }
}

# SSL ì¶”ê°€
server {
        listen 443 ssl;
        server_name wypl.site;

        ssl_certificate /etc/letsencrypt/live/wypl.site/fullchain.pem;  # SSL ì¸ì¦ì„œ íŒŒì¼
        ssl_certificate_key /etc/letsencrypt/live/wypl.site/privkey.pem;  # SSL í‚¤ íŒŒì¼

        location / {
                proxy_pass http://IPì£¼ì†Œ:8100;
        }
}
```

ì‹¬ë³¼ë¦­ ë§í¬ ì„¤ì •

```bash
sudo ln -s /etc/nginx/sites-available/íŒŒì¼ëª….conf /etc/nginx/sites-enabled
```


ë¬¸ë²• í™•ì¸
    
    ```groovy
    sudo nginx -t
    ```
    
nginx reload
    
    ```groovy
    sudo systemctl reload nginx
    ```
    

### âœ… ì  í‚¨ìŠ¤ credential ì¶”ê°€

.yml í˜•ì‹ì˜ ì„¤ì • íŒŒì¼ì„  jenkins credentialsì— ì¶”ê°€í•œë‹¤.

Dashboard > Jenkins ê´€ë¦¬ > Credentials > System > Global 


### âœ…ë°±ì—”ë“œ, í”„ë¡ íŠ¸ profile ì„¤ì •

<aside>
ğŸ’¡ **profile** ê¸°ëŠ¥ìœ¼ë¡œ í™˜ê²½ì„ ë¶„ë¦¬í•´ì„œ ê°œë°œí•˜ëŠ” ë°©ë²•

ë‹¤ì–‘í•œ ë°©ë²•ì´ ìˆì§€ë§Œ JVM SYSTEM PARAMETERë¡œ ì£¼ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

```java
-Dspring.profiles.active=dev
```

â†’ í”„ë¡œì íŠ¸ ë‚´ì— `active-profile = dev` ì˜ ì½”ë“œë¥¼ í†µí•´ ëª…ì‹œí•˜ëŠ” ë°©ì‹ë³´ë‹¤ **ìë™í™” ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±ì— ìš©ì´**í•˜ë‹¤. 

</aside>

- jenkins pipline ìˆ˜ì •

```jsx
docker run -d --name $DOCKER_IMAGE_NAME -e PROFILE=dev -p 8800:8080 wypl-web-dev:latest
```

Docker file ìˆ˜ì •

```jsx
ENTRYPOINT ["java", "-jar","-Dspring.profiles.active=${PROFILE}", "wypl.jar"]
```